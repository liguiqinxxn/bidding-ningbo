name: Test & Coverage

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Run tests with coverage
        run: npm run test:coverage

      - name: Check coverage thresholds
        run: |
          # è¯»å– JSON æŠ¥å‘Š
          if [ ! -f "coverage/coverage-summary.json" ]; then
            echo "âŒ Coverage report not found!"
            exit 1
          fi

          # æå–è¦†ç›–ç‡æ•°æ®
          STATEMENTS=$(node -e "console.log(JSON.parse(require('fs').readFileSync('coverage/coverage-summary.json', 'utf8')).total.statements.pct)")
          BRANCHES=$(node -e "console.log(JSON.parse(require('fs').readFileSync('coverage/coverage-summary.json', 'utf8')).total.branches.pct)")
          FUNCTIONS=$(node -e "console.log(JSON.parse(require('fs').readFileSync('coverage/coverage-summary.json', 'utf8')).total.functions.pct)")
          LINES=$(node -e "console.log(JSON.parse(require('fs').readFileSync('coverage/coverage-summary.json', 'utf8')).total.lines.pct)")

          # å®šä¹‰é˜ˆå€¼
          MIN_STATEMENTS=80
          MIN_BRANCHES=75
          MIN_FUNCTIONS=80
          MIN_LINES=80

          echo "ğŸ“Š Coverage Results:"
          echo "  Statements: $STATEMENTS% (min $MIN_STATEMENTS%)"
          echo "  Branches:   $BRANCHES% (min $MIN_BRANCHES%)"
          echo "  Functions:  $FUNCTIONS% (min $MIN_FUNCTIONS%)"
          echo "  Lines:      $LINES% (min $MIN_LINES%)"

          # æ£€æŸ¥æ˜¯å¦è¾¾æ ‡
          failed=false
          [[ $(echo "$STATEMENTS < $MIN_STATEMENTS" | bc -l) == "1" ]] && echo "âŒ Statements below threshold!" && failed=true
          [[ $(echo "$BRANCHES < $MIN_BRANCHES" | bc -l) == "1" ]] && echo "âŒ Branches below threshold!" && failed=true
          [[ $(echo "$FUNCTIONS < $MIN_FUNCTIONS" | bc -l) == "1" ]] && echo "âŒ Functions below threshold!" && failed=true
          [[ $(echo "$LINES < $MIN_LINES" | bc -l) == "1" ]] && echo "âŒ Lines below threshold!" && failed=true

          if [ "$failed" = true ]; then
            echo "ğŸ’¥ Coverage threshold not met!"
            exit 1
          else
            echo "âœ… All coverage thresholds met!"
          fi